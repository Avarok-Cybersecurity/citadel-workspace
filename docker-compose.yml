services:
  server:
    build:
      context: .
      dockerfile: ./docker/workspace-server/Dockerfile
    volumes:
      # Mount relevant codebase for live updates
      - target_cache:/usr/src/app/target
    environment:
      - RUST_LOG=citadel=info
    # Healthcheck disabled to avoid WebSocket handshake errors in logs
    healthcheck:
      test: [ "CMD", "nc", "-z", "127.0.0.1", "12349" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    ports:
      - "12349:12349"
      - "12345:12345"  # Internal service WebSocket port (shared network namespace)
    networks:
      - citadel-net
  internal-service:
    build:
      context: .
      dockerfile: ./docker/internal-service/Dockerfile
      args:
        - INTERNAL_SERVICE_PORT=${INTERNAL_SERVICE_PORT}
    volumes:
      # Mount shared caches and target directory
      - target_cache:/usr/src/app/target
    environment:
      - RUST_LOG=citadel=debug
      - DOCKER_CONTAINER=1
      - SKIP_WASM_BUILD=1
    healthcheck:
      test: ["CMD-SHELL", "netstat -tuln | grep -q \":$${INTERNAL_SERVICE_PORT}\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    depends_on:
      server:
        condition: service_healthy
    network_mode: service:server

# Define named volumes for caching
volumes:
  target_cache:

# Define the network
networks:
  citadel-net:
    driver: bridge
