use crate::handlers::domain::DomainOperations;
use crate::handlers::domain::server_ops::DomainServerOperations;
use crate::handlers::domain::functions::user as user_ops;
use crate::kernel::transaction::rbac::DomainType;
use crate::WORKSPACE_ROOT_ID;

use citadel_sdk::prelude::{NetworkError, Ratchet};
use citadel_workspace_types::structs::{Permission, UserRole};
use citadel_workspace_types::UpdateOperation;

// Standalone methods implementation
impl<R: Ratchet + Send + Sync + 'static> DomainServerOperations<R> {
    /// Get permission data for a user
    pub fn get_permission_data_for_user(
        &self,
        actor_user_id: &str,
        target_user_id: &str,
    ) -> Result<Vec<(String, Vec<String>)>, NetworkError> {
        self.tx_manager.with_read_transaction(|tx| {
            // Admin can see any user's permissions
            let is_admin = self.is_admin(tx, actor_user_id)?;
            
            // Users can see their own permissions
            if actor_user_id != target_user_id && !is_admin {
                return Err(NetworkError::msg(format!(
                    "Permission denied: User '{}' does not have permission to view permissions for user '{}'",
                    actor_user_id, target_user_id
                )));
            }
            
            // Get all domains the user is a member of, with their permissions
            user_ops::get_all_user_domain_permissions(tx, target_user_id)
        })
    }

    /// Update a user's role in a specific domain
    pub fn update_user_role(
        &self,
        actor_user_id: &str,
        target_user_id: &str,
        domain_id: &str,
        role: UserRole,
        metadata: Option<Vec<u8>>,
    ) -> Result<(), NetworkError> {
        // If domain is the workspace root, handle it differently
        if domain_id == WORKSPACE_ROOT_ID {
            return self.update_workspace_member_role(actor_user_id, target_user_id, role, metadata);
        }
        
        self.tx_manager.with_write_transaction(|tx| {
            // Check if actor has permission
            if !self.check_entity_permission(tx, actor_user_id, domain_id, Permission::ManageRoles)? {
                return Err(NetworkError::msg(format!(
                    "User '{}' does not have permission to update user roles in domain '{}'",
                    actor_user_id, domain_id
                )));
            }
            
            // Update the user's role in the domain
            user_ops::update_user_domain_role(tx, target_user_id, domain_id, role)?;
            
            Ok(())
        })
    }
    /// Add a user to a domain entity with a specific role
    pub async fn add_user_to_domain_entity_with_role(
        &self,
        user_id_to_add: &str,
        entity_id: &str,
        domain_type: DomainType,
        role: UserRole,
        actor_user_id: Option<&str>,
    ) -> Result<(), NetworkError> {
        let effective_actor_id = actor_user_id.unwrap_or(user_id_to_add);

        // Note: As per the memory, changes are immediately applied to in-memory storage during the transaction
        self.tx_manager.with_write_transaction(|tx| {
            user_ops::add_user_to_domain_inner(
                tx,
                effective_actor_id,
                user_id_to_add,
                entity_id,
                role,
                None,
            )
            .map(|_| ()) // Map Ok(User) to Ok(())
        })
    }

impl<R: Ratchet + Send + Sync + 'static> DomainOperations<R> for DomainServerOperations<R> {
    /// Add a user to a domain with a specific role
    fn add_user_to_domain(
        &self,
        admin_id: &str,
        user_id_to_add: &str,
        domain_id: &str,
        role: UserRole,
    ) -> Result<(), NetworkError> {
        // Using the transaction manager to handle transactions
        self.tx_manager.with_write_transaction(|tx| {
            // Check if admin has permission
            if !self.check_entity_permission(tx, admin_id, domain_id, Permission::ManageMembers)? {
                return Err(NetworkError::msg(format!(
                    "Permission denied: User '{}' does not have permission to add users to domain '{}'",
                    admin_id, domain_id
                )));
            }

            // Add user to domain
            user_ops::add_user_to_domain_inner(tx, admin_id, user_id_to_add, domain_id, role, None)?;
            
            Ok(())
        })
    }

    /// Remove a user from a domain
    fn remove_user_from_domain(
        &self,
        admin_id: &str,
        user_id_to_remove: &str,
        domain_id: &str,
    ) -> Result<(), NetworkError> {
        self.tx_manager.with_write_transaction(|tx| {
            // Check if admin has permission
            if !self.check_entity_permission(tx, admin_id, domain_id, Permission::ManageMembers)? {
                return Err(NetworkError::msg(format!(
                    "Permission denied: User '{}' does not have permission to remove users from domain '{}'",
                    admin_id, domain_id
                )));
            }

            // Remove user from domain
            user_ops::remove_user_from_domain(tx, user_id_to_remove, domain_id)
        })
    }

    /// Update a workspace member's role
    fn update_workspace_member_role(
        &self,
        actor_user_id: &str,
        target_user_id: &str,
        role: UserRole,
        _metadata: Option<Vec<u8>>, // metadata is unused for now
    ) -> Result<(), NetworkError> {
        self.tx_manager.with_write_transaction(|tx| {
            // First, check if actor is admin
            if !self.is_admin(tx, actor_user_id)? {
                return Err(NetworkError::msg(format!(
                    "Permission denied: User '{}' does not have permission to update user roles",
                    actor_user_id
                )));
            }

            // Check if target user exists
            if tx.get_user(target_user_id).is_none() {
                return Err(NetworkError::msg(format!(
                    "User '{}' not found",
                    target_user_id
                )));
            }

            // Cannot update role of the admin
            if tx.get_user(target_user_id).map(|u| u.role == UserRole::Admin).unwrap_or(false) {
                return Err(NetworkError::msg(
                    "Permission denied: Cannot update role of the admin user"
                ));
            }

            // Update the user's role
            user_ops::update_user_role(tx, target_user_id, role)?;
            
            // If the role is being set to Banned or Guest (low privileges),
            // we also need to remove them from all domains (offices and rooms)
            if role == UserRole::Banned {
                user_ops::remove_user_from_all_domains(tx, target_user_id)?;
            }

            Ok(())
        })
    }

    /// Update a member's permissions
    fn update_member_permissions(
        &self,
        actor_user_id: &str,
        target_user_id: &str,
        domain_id: &str,
        permissions_to_update: Vec<Permission>,
        operation: UpdateOperation,
    ) -> Result<(), NetworkError> {
        self.tx_manager.with_write_transaction(|tx| {
            // Check if actor has permission to update permissions in this domain
            if !self.check_entity_permission(tx, actor_user_id, domain_id, Permission::ManagePermissions)? {
                return Err(NetworkError::msg(format!(
                    "User '{}' does not have permission to update permissions in domain '{}'",
                    actor_user_id, domain_id
                )));
            }

            // Check if target user exists and is a member of the domain
            if !self.is_member_of_domain(tx, target_user_id, domain_id)? {
                return Err(NetworkError::msg(format!(
                    "User '{}' is not a member of domain '{}'",
                    target_user_id, domain_id
                )));
            }

            // Update permissions
            match operation {
                UpdateOperation::Add => {
                    // Add each permission
                    for permission in permissions_to_update {
                        user_ops::add_permission_to_user_domain(
                            tx, 
                            target_user_id, 
                            domain_id, 
                            permission
                        )?;
                    }
                }
                UpdateOperation::Remove => {
                    // Remove each permission
                    for permission in permissions_to_update {
                        user_ops::remove_permission_from_user_domain(
                            tx, 
                            target_user_id, 
                            domain_id, 
                            permission
                        )?;
                    }
                }
                UpdateOperation::Set => {
                    // Replace all permissions with the new set
                    user_ops::set_user_domain_permissions(
                        tx, 
                        target_user_id, 
                        domain_id, 
                        permissions_to_update
                    )?;
                }
            }
            
            Ok(())
        })
    }

}
